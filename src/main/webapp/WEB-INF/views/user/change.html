<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/base}">
<head>
<title>change</title>
<link rel="stylesheet" th:href="@{/css/tippy.css}">
<script th:src="@{/js/tippy.min.js}"></script>
<style>
html {
	height: 100%;
}
</style>
<script>
	$(function() {
		const check = '<i class="fas fa-check-circle text-success"></i>';
		const times = '<i class="fas fa-times-circle text-danger"></i>';

		tippy.one('#password', {
			animation : 'fade',
			arrow : true,
			placement : 'top',
			//size : 'small',
			hideOnClick : false,
			trigger : 'focus'
		});

		$('#password').on('input', function() {
			checkPassword($(this).val());
			confirmPassword($(this).val(), $('#confirm').val());
		});
		function checkPassword(password) {
			var label = $('label[for="password"]');
			label.children('i').remove();
			if (password.length == 0)
				return;

			var strength = checkStrength(password);
			if (strength == 2) {
				label.append(check);
			} else {
				label.append(times);
			}
		}

		function checkStrength(password) {
			var strength = 0;
			if (password.length >= 4 && password.length <= 16
					&& /^[\u0020-\u007e]+$/.test(password)) {
				if (/[a-zA-Z]+/.test(password))
					strength++;
				if (/[0-9]+/.test(password))
					strength++;
			}
			return strength;
		}

		$('#confirm').on('input', function() {
			confirmPassword($('#password').val(), $(this).val());
		});
		function confirmPassword(password, confirm) {
			var label = $('label[for="confirm"]');
			label.children('i').remove();
			if (confirm.length == 0)
				return;

			if (password == confirm) {
				label.append(check);
			} else {
				label.append(times);
			}
		}

		function isValidForm(obj) {
			var isValid = true;

			// clear error
			$('.is-invalid').removeClass('is-invalid');
			$('.invalid-feedback').remove();

			if ($('#password').val().length == 0) {
				$('#password').addClass('is-invalid');
				$('#password').after($('<div/>', {
					'class' : 'invalid-feedback',
					text : 'password error!'
				}));
				isValid = false;
			} else if (checkStrength($('#password').val()) != 2) {
				$('#password').addClass('is-invalid');
				$('#password').after($('<div/>', {
					'class' : 'invalid-feedback',
					text : 'password partten!'
				}));
				isValid = false;
			}

			if ($('#password').val() != $('#confirm').val()) {
				$('#confirm').addClass('is-invalid');
				$('#confirm').after($('<div/>', {
					'class' : 'invalid-feedback',
					text : 'confirm error!'
				}));
				isValid = false;
			}

			return isValid;
		}

		$('#fomChange').submit(function(event) {
			if (!isValidForm()) {
				event.preventDefault();
				event.stopPropagation();
			} else {
				$('#mdlWaiting').modal('show');
			}
		});
	});
</script>
</head>
<body layout:fragment="body" class="pt-header d-flex align-items-center">
	<header layout:insert="~{layout/parts/header::user(1)}"
		class="fixed-top bg-header"></header>
	<th:block layout:replace="~{layout/parts/dialog::logout}" />

	<th:block layout:replace="~{layout/parts/dialog::waiting}" />
	<div class="container bg-main my-auto pb-5">
		<th:block layout:replace="~{layout/parts/alert::info}" />
		<form id="fomChange" class="mw-content mx-auto pt-3" novalidate
			th:action="@{/user/change}" th:object="${changeForm}" method="post"
			autocomplete="off">
			<h4>パスワード変更</h4>
			<hr>
			<div class="form-group row">
				<label for="username" class="col-sm-4 col-form-label text-sm-right">ユーザー名</label>
				<div class="col-sm-8">
					<input type="text" th:field="*{username}" class="form-control"
						readonly />
				</div>
			</div>
			<div class="form-group row">
				<label for="email" class="col-sm-4 col-form-label text-sm-right">メールアドレス</label>
				<div class="col-sm-8">
					<input type="email" th:field="*{email}" class="form-control"
						readonly />
				</div>
			</div>
			<div class="form-group row">
				<label for="password" class="col-sm-4 col-form-label text-sm-right">新しいパスワード<span
					id="result"></span></label>
				<div class="col-sm-8">
					<input type="password" th:field="*{password}" class="form-control"
						th:title="#{tooltip.signup.password}" th:errorclass="is-invalid"
						maxlength="16" placeholder="" />
					<div class="invalid-feedback"
						th:if="${#fields.hasErrors('password')}" th:errors="*{password}">password
						error</div>
				</div>
			</div>
			<div class="form-group row">
				<label for="confirm" class="col-sm-4 col-form-label text-sm-right">パスワード確認</label>
				<div class="col-sm-8">
					<input type="password" th:field="*{confirm}" class="form-control"
						th:errorclass="is-invalid" maxlength="16" placeholder="" />
					<div class="invalid-feedback"
						th:if="${#fields.hasErrors('confirm')}" th:errors="*{confirm}">confirm
						error</div>
				</div>
			</div>
			<div class="form-group row">
				<div class="offset-sm-4 col-sm-8">
					<button id="btnChange" type="submit"
						class="btn btn-primary btn-block-xs" style="width: 150px;">変更</button>
				</div>
			</div>
		</form>
	</div>
</body>
</html>